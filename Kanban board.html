<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kanban</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- ðŸ”¥ Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDn0I-ZzftCN44f1p9DZsNYS-ozyqwAj9g",
  authDomain: "kanban-board-b7cad.firebaseapp.com",
  databaseURL: "https://kanban-board-b7cad-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "kanban-board-b7cad",
  storageBucket: "kanban-board-b7cad.firebasestorage.app",
  messagingSenderId: "915085157397",
  appId: "1:915085157397:web:7b8b6eb102f67c32449a1c"
};

const appFB = initializeApp(firebaseConfig);
const db = getDatabase(appFB);

/* ====== à¸•à¸±à¸§à¹à¸›à¸£à¹€à¸”à¸´à¸¡ ====== */
let currentUser = null;
const loginBox = document.getElementById("loginBox");
const app = document.getElementById("app");
const board = document.getElementById("board");
let dragged = null;

const today = () => new Date().toISOString().split("T")[0];
const boardRef = () => ref(db, "kanban/" + currentUser);

/* ====== LOGIN ====== */
window.login = function(){
    if(!username.value) return;
    currentUser = username.value;
    loginBox.style.display = "none";
    app.style.display = "block";
    loadBoard();
}

window.logout = function(){
    location.reload();
}

/* ====== SAVE / LOAD (à¹à¸—à¸™ localStorage) ====== */
function saveBoard(){
    if(!currentUser) return;
    set(boardRef(), {
        html: board.innerHTML,
        updated: Date.now()
    });
}

function loadBoard(){
    onValue(boardRef(), snap=>{
        if(snap.exists()){
            board.innerHTML = snap.val().html;
            rebind();
        }
    });
}

/* ====== REBIND à¹€à¸”à¸´à¸¡ 100% ====== */
function rebind(){
    document.querySelectorAll(".task").forEach(t=>{
        t.draggable = true;
        t.ondragstart = () => dragged = t;
    });

    document.querySelectorAll(".column").forEach(c=>{
        c.ondragover = e => e.preventDefault();
        c.ondrop = e =>{
            e.preventDefault();
            if(!dragged) return;
            c.appendChild(dragged);
            const input = dragged.querySelector("input");
            if(c.dataset.status === "COMPLETED"){
                input.value = 100;
                input.disabled = true;
                dragged.classList.add("completed");
            }else{
                input.disabled = false;
                dragged.classList.remove("completed");
            }
            saveBoard();
            dragged = null;
        }
    });

    document.querySelectorAll(".waiting-item").forEach(item=>{
        const textarea = item.querySelector("textarea");
        if(textarea){
            textarea.value = item.dataset.note || "";
            textarea.oninput = () => {
                item.dataset.note = textarea.value;
                saveBoard();
            };
        }
        item.querySelector(".waiting-delete").onclick = ()=>{
            item.remove();
            saveBoard();
        };
    });
}

/* ====== ADD WAITING ====== */
function addWaitingItem(title, date){
    const d = document.createElement("div");
    d.className = "waiting-item";
    d.dataset.note = "";
    d.innerHTML = `
        <strong>${title}</strong><br>
        ðŸ“… ${date}
        <textarea placeholder="à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸"></textarea>
        <button class="waiting-delete">à¸¥à¸š</button>
    `;
    document.getElementById("waitingList").appendChild(d);
    rebind();
    saveBoard();
}

/* ====== ADD TASK ====== */
window.addTask = function(){
    if(!workDate.value || !workType.value || !workTask.value) return;

    const t = document.createElement("div");
    t.className = `task ${workType.value.toLowerCase()}`;
    t.innerHTML = `
        <strong>[${workType.value}] ${workTask.value}</strong>
        <small>${workDate.value}</small>
        <div class="progress-box">
            <input type="number" value="0" min="0" max="100"> %
        </div>
        <button class="delete-btn" onclick="this.parentElement.remove();saveBoard()">à¸¥à¸š</button>
    `;

    if(new Date(workDate.value) < new Date(today())){
        document.querySelector(".backlog").appendChild(t);
        addWaitingItem(workTask.value, workDate.value);
    }else{
        document.querySelector(".todo").appendChild(t);
    }

    workTask.value = "";
    rebind();
    saveBoard();
}

/* ====== EXPORT (à¹€à¸”à¸´à¸¡) ====== */
window.exportPNG = function(){
    html2canvas(board).then(c=>{
        const a=document.createElement("a");
        a.href=c.toDataURL();
        a.download="kanban.png";
        a.click();
    });
}

window.exportPDF = function(){
    html2canvas(board).then(c=>{
        const pdf=new jspdf.jsPDF("l","pt","a4");
        const w=pdf.internal.pageSize.getWidth();
        pdf.addImage(c,"PNG",0,0,w,c.height*w/c.width);
        pdf.save("kanban.pdf");
    });
}

window.exportExcel = function(){
    const rows=[["Status","Type","Task","Date","Progress"]];
    document.querySelectorAll(".column").forEach(col=>{
        col.querySelectorAll(".task").forEach(t=>{
            rows.push([
                col.dataset.status,
                t.classList.contains("pm")?"PM":"CM",
                t.querySelector("strong").innerText,
                t.querySelector("small").innerText,
                t.querySelector("input").value
            ]);
        });
    });
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(rows),"KANBAN");
    XLSX.writeFile(wb,"kanban.xlsx");
}
</script>
</head>

<body>
<!-- BODY + CSS à¹ƒà¸Šà¹‰à¸‚à¸­à¸‡à¹€à¸”à¸´à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” -->
</body>
</html>
