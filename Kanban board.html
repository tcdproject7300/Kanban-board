<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kanban</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* === (CSS เหมือนเดิมทุกประการ) === */
:root{
  --glass:rgba(255,255,255,.55);
  --blur:blur(24px);
  --radius:26px;
  --shadow-soft:0 30px 60px rgba(0,0,0,.18);
  --pm:#4f8cff;
  --cm:#ff6b6b;
}
body{
  margin:0;
  font-family:-apple-system,"Segoe UI",Roboto;
  background:linear-gradient(135deg,#eef2ff,#fdfbff);
}
#loginBox{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
#loginBox .box{
  background:var(--glass);
  backdrop-filter:var(--blur);
  padding:34px;
  border-radius:var(--radius);
  box-shadow:var(--shadow-soft);
  text-align:center;
}
#loginBox input{
  padding:14px;
  border-radius:18px;
  border:none;
}
#loginBox button{
  margin-top:14px;
  padding:12px 26px;
  border:none;
  border-radius:20px;
  font-weight:700;
  background:#5e35ff;
  color:#fff;
}
#app{display:none}
header{
  margin:20px;
  padding:26px;
  background:var(--glass);
  border-radius:var(--radius);
  box-shadow:var(--shadow-soft);
  text-align:center;
  font-size:26px;
  font-weight:900;
  position:relative;
}
header button{
  position:absolute;
  right:24px;
  top:24px;
  background:#ff5252;
  color:#fff;
  border:none;
  padding:10px 20px;
  border-radius:18px;
}
.board{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:20px;
  padding:20px;
}
.column{
  background:var(--glass);
  border-radius:var(--radius);
  padding:16px;
}
.column h3{
  text-align:center;
  padding:10px;
  border-radius:18px;
  background:#ffffffaa;
}
.task{
  background:#fff;
  border-radius:20px;
  padding:14px;
  margin-bottom:12px;
}
.task.pm{border-left:6px solid var(--pm)}
.task.cm{border-left:6px solid var(--cm)}
.task.completed{background:#d4f8e3}
</style>
</head>

<body>

<div id="loginBox">
  <div class="box">
    <h2>เข้าสู่ระบบ</h2>
    <input id="username" placeholder="ชื่อไซต์ / ผู้ใช้งาน">
    <br>
    <button onclick="login()">เข้าใช้งาน</button>
  </div>
</div>

<div id="app">
<header>
  KANBAN BOARD
  <button onclick="logout()">Logout</button>
</header>

<div class="board" id="board">
  <div class="column backlog" data-status="BACKLOG"><h3>BACKLOG</h3></div>
  <div class="column waiting" data-status="WAITING"><h3>WAITING ⏰</h3></div>
  <div class="column todo" data-status="TO-DO"><h3>TO-DO</h3></div>
  <div class="column progress-col" data-status="IN PROGRESS"><h3>IN PROGRESS</h3></div>
  <div class="column done" data-status="COMPLETED"><h3>COMPLETED ✔</h3></div>
</div>
</div>

<!-- ================= FIREBASE ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, get, set }
from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDn0I-ZzftCN44f1p9DZsNYS-ozyqwAj9g",
  databaseURL: "https://kanban-board-b7cad-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "kanban-board-b7cad"
};

const appFB = initializeApp(firebaseConfig);
const db = getDatabase(appFB);

let currentUser = localStorage.getItem("kb-user");
const board = document.getElementById("board");

window.login = async ()=>{
  if(!username.value) return;
  currentUser = username.value;
  localStorage.setItem("kb-user",currentUser);
  loginBox.style.display="none";
  app.style.display="block";
  await loadBoard();
};

window.logout = ()=>{
  localStorage.removeItem("kb-user");
  location.reload();
};

if(currentUser){
  loginBox.style.display="none";
  app.style.display="block";
  loadBoard();
}

async function saveBoard(){
  await set(ref(db,"kanban/"+currentUser),{
    html: board.innerHTML
  });
}

async function loadBoard(){
  const snap = await get(ref(db,"kanban/"+currentUser));
  if(snap.exists()){
    board.innerHTML = snap.val().html;
    rebind();
  }
}

function rebind(){
  document.querySelectorAll(".task").forEach(t=>{
    t.draggable=true;
    t.ondragstart=()=>dragged=t;
  });
  document.querySelectorAll(".column").forEach(c=>{
    c.ondragover=e=>e.preventDefault();
    c.ondrop=e=>{
      e.preventDefault();
      if(!dragged) return;
      c.appendChild(dragged);
      saveBoard();
      dragged=null;
    };
  });
}
</script>

</body>
</html>
